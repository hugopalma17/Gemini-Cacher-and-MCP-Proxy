<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Brain - Gemini</title>
    <!-- Local Assets (embedded) -->
    <script src="/assets/marked.min.js"></script>
    <link href="/assets/prism.css" rel="stylesheet" />
    <script src="/assets/prism.js"></script>
    <script src="/assets/prism-go.js"></script>
    <script src="/assets/prism-bash.js"></script>
    <script src="/assets/prism-json.js"></script>
    <script src="/assets/prism-python.js"></script>
    <!-- Unicons -->
    <link rel="stylesheet" href="https://unpkg.com/@iconscout/unicons@4.0.8/css/line.css">
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --chat-bg: #0f172a;
            --accent-color: #38bdf8;
            --text-color: #f8fafc;
            --msg-user: #1e293b;
            --msg-bot: #334155;
            --glass: rgba(255, 255, 255, 0.05);
            --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
            flex-shrink: 0;
        }
        #sidebar h2 { font-size: 1rem; margin-bottom: 0.75rem; color: var(--accent-color); display: flex; align-items: center; gap: 0.4rem; }
        .caching-badge {
            font-size: 0.6rem;
            background: var(--accent-color);
            color: #000;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 0.75rem;
            display: inline-block;
        }
        .help-btn {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent-color);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .help-btn:hover { background: rgba(255,255,255,0.1); }

        /* File Tree */
        #file-tree {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .tree-item {
            display: flex;
            align-items: center;
            padding: 0.35rem 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            gap: 0.5rem;
            user-select: none;
        }
        .tree-item:hover { background: rgba(255,255,255,0.08); }
        .tree-item.selected { background: var(--accent-color); color: #000; }
        .tree-item i { font-size: 1rem; flex-shrink: 0; }
        .tree-item .name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tree-children { margin-left: 1rem; display: none; }
        .tree-children.expanded { display: block; }
        .tree-folder > .tree-item i.folder-icon { transition: transform 0.2s; }
        .tree-folder.open > .tree-item i.folder-icon { transform: rotate(90deg); }

        /* Modal */
        #help-modal, #settings-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--sidebar-bg);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }
        #settings-modal .modal-content {
            max-width: 600px;
        }
        .modal-content h2 i, .modal-content h3 i { margin-right: 0.4rem; color: var(--accent-color); }
        .modal-content pre {
            margin: 0.75rem 0;
            padding: 0;
            background: transparent;
        }
        .modal-content code {
            display: block;
            background: #000;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            margin: 0;
            color: #38bdf8;
            font-family: monospace;
            font-size: 0.65rem;
            line-height: 1.3;
            white-space: pre-wrap;
            overflow-x: auto;
            word-break: break-all;
            max-width: 100%;
        }
        .close-btn {
            position: absolute;
            top: 1rem; right: 1rem;
            cursor: pointer;
            color: #fff;
            font-size: 1.5rem;
        }
        
        /* Settings Modal */
        .setting-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .setting-group:last-child {
            border-bottom: none;
        }
        .setting-group h3 {
            font-size: 1rem;
            margin: 0 0 0.75rem 0;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .setting-group label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .setting-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .setting-group input[type="range"] {
            width: 100%;
            margin-top: 0.5rem;
        }
        .setting-value {
            display: inline-block;
            background: var(--glass);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent-color);
            font-size: 0.9rem;
            min-width: 40px;
            text-align: center;
        }
        .setting-description {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.25rem;
            line-height: 1.4;
        }
        .save-settings-btn {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            width: 100%;
            margin-top: 1rem;
        }
        .save-settings-btn:hover {
            opacity: 0.9;
        }

        /* Topbar */
        #topbar {
            background: var(--sidebar-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        #topbar h1 {
            font-size: 1.25rem;
            margin: 0;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #session-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.9rem;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: var(--glass);
            border-radius: 6px;
        }
        .stat-value {
            font-family: monospace;
            color: var(--accent-color);
            font-weight: bold;
        }
        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
        }

        /* Main Chat */
        #main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .message {
            max-width: 85%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-msg {
            align-self: flex-end;
            background: var(--msg-user);
            border-bottom-right-radius: 2px;
        }
        .bot-msg {
            align-self: flex-start;
            background: var(--msg-bot);
            border-bottom-left-radius: 2px;
            border-left: 4px solid var(--accent-color);
        }

        /* Markdown Styles */
        .message p { margin: 0 0 1rem 0; }
        .message p:last-child { margin-bottom: 0; }
        .message code:not(pre code) { background: rgba(0,0,0,0.4); padding: 0.15rem 0.4rem; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.9em; color: #f472b6; }
        .message pre { position: relative; background: #1a1a2e !important; padding: 1rem; padding-top: 2.5rem; border-radius: 8px; overflow-x: auto; margin: 1rem 0; max-width: 100%; }
        .message pre code { background: transparent; padding: 0; color: inherit; font-size: 0.85rem; }
        .message ul, .message ol { margin: 0.5rem 0 1rem 1.5rem; }
        .message li { margin-bottom: 0.4rem; }
        .message h1, .message h2, .message h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; color: #fff; }
        .message a { color: var(--accent-color); text-decoration: none; }
        .message a:hover { text-decoration: underline; }
        .message img { max-width: 100%; height: auto; border-radius: 8px; margin: 0.5rem 0; }
        .message table { border-collapse: collapse; margin: 1rem 0; width: 100%; }
        .message th, .message td { border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem; text-align: left; }
        .message th { background: rgba(255,255,255,0.1); }

        /* Code Copy Button */
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .copy-btn:hover { opacity: 1; background: rgba(255,255,255,0.2); }
        .copy-btn.copied { background: #22c55e; }

        .token-info {
            display: block;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            margin-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.3rem;
        }

        /* Input Area */
        #input-wrapper {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 1rem 2rem;
        }
        #attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        #attachments:empty { display: none; margin-bottom: 0; }
        .attachment-pill {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(56, 189, 248, 0.2);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .attachment-pill i { font-size: 0.9rem; }
        .attachment-pill .remove {
            cursor: pointer;
            margin-left: 0.2rem;
            opacity: 0.7;
        }
        .attachment-pill .remove:hover { opacity: 1; color: var(--danger); }
        .attachment-thumb {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--accent-color);
        }
        .attachment-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .attachment-thumb .remove {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }
        #input-row {
            display: flex;
            gap: 1rem;
        }
        #msg-input {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            padding: 0.85rem 1rem;
            border-radius: 8px;
            outline: none;
            font-size: 1rem;
        }
        #msg-input:focus { border-color: var(--accent-color); }
        #send-btn {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 0 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        #send-btn:active { transform: scale(0.95); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Select styling */
        select {
            width: 100%;
            padding: 0.5rem;
            background: var(--chat-bg);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            outline: none;
            font-size: 0.85rem;
        }
        select:focus { border-color: var(--accent-color); }

        /* Checkbox label */
        .option-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            background: var(--glass);
        }
        .option-label:hover { background: rgba(255,255,255,0.08); }
        .option-label input { width: 1rem; height: 1rem; accent-color: var(--accent-color); }

        /* Tool Activity */
        #tool-activity {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 0.5rem;
        }
        #tool-activity:empty::before {
            content: 'No recent activity';
            color: rgba(255,255,255,0.3);
            font-style: italic;
        }
        .tool-log {
            display: flex;
            align-items: flex-start;
            gap: 0.4rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: toolFade 0.3s ease-out;
        }
        .tool-log:last-child { border-bottom: none; }
        .tool-log i { color: var(--accent-color); flex-shrink: 0; margin-top: 2px; }
        .tool-log .tool-name { color: #22c55e; font-weight: 500; }
        .tool-log .tool-args { color: rgba(255,255,255,0.6); word-break: break-all; }
        @keyframes toolFade { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="caching-badge" id="badge-cache" style="display: none;">CACHE ACTIVE</div>
        <h2><i class="uil uil-folder-open"></i> Files</h2>
        <div id="file-tree">Loading...</div>

        <h2 style="margin-top: 1rem;"><i class="uil uil-robot"></i> Model</h2>
        <select id="model-select"></select>

        <h2 style="margin-top: 1rem;"><i class="uil uil-setting"></i> Options</h2>
        <label class="option-label" id="agentic-label">
            <input type="checkbox" id="agentic-toggle" checked>
            <i class="uil uil-robot"></i> Agentic Mode
        </label>
        <label class="option-label" style="margin-top: 0.5rem;">
            <input type="checkbox" id="search-toggle">
            <i class="uil uil-search"></i> Google Search
        </label>
        
        <button class="help-btn" onclick="resetSession()" style="margin-top: 0.75rem; background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger);">
            <i class="uil uil-redo"></i> New Session
        </button>

        <button class="help-btn" onclick="showSettings()" style="margin-top: 0.5rem;">
            <i class="uil uil-sliders-v-alt"></i> Advanced Settings
        </button>

        <h2 style="margin-top: 1rem;"><i class="uil uil-wrench"></i> Tool Activity</h2>
        <div id="tool-activity"></div>

        <div id="cache-status" style="margin-top: auto; padding-top: 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.4); border-top: 1px solid rgba(255,255,255,0.1);">
            <div>Cache: <span id="cache-name">Checking...</span></div>
            <div style="margin-top: 0.25rem;">Session: <span id="session-id" style="font-family: monospace; font-size: 0.7rem;">Loading...</span></div>
        </div>
        <div class="help-btn" onclick="showHelp()"><i class="uil uil-question-circle"></i> Integration Help</div>
    </div>

    <div id="help-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelp()">&times;</span>
            <h2><i class="uil uil-rocket"></i> Integration Guide</h2>
            <p>This server exposes OpenAI-compatible APIs. Use <code style="display:inline; margin:0;">http://localhost{{.ServerPort}}/v1</code> as your base URL.</p>

            <h3><i class="uil uil-wifi"></i> Available Endpoints</h3>
            <table style="width:100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.85rem;">
                <tr style="background: rgba(255,255,255,0.1);"><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);"><code style="display:inline; margin:0;">/v1/chat/completions</code></td><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);">OpenAI-compatible (streaming)</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);"><code style="display:inline; margin:0;">/v1/models</code></td><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);">OpenAI models list</td></tr>
                <tr style="background: rgba(255,255,255,0.1);"><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);"><code style="display:inline; margin:0;">/chat</code></td><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);">Native endpoint (tools, search)</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);"><code style="display:inline; margin:0;">/status</code></td><td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2);">Server status</td></tr>
            </table>

            <h3>1. <i class="uil uil-desktop"></i> Cursor</h3>
            <p>Open Cursor Settings and configure:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                <li><strong>Provider:</strong> OpenAI Compatible / Custom OpenAI</li>
                <li><strong>Base URL:</strong> <code style="display:inline; margin:0;">http://localhost{{.ServerPort}}/v1</code></li>
                <li><strong>API Key:</strong> Any value (e.g., <code style="display:inline; margin:0;">x</code>) - ignored by proxy</li>
                <li><strong>Model:</strong> <code style="display:inline; margin:0;">gpt-4</code> (proxy translates to Gemini)</li>
            </ul>
            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">Note: For MCP tools, use <code style="display:inline; margin:0;">~/.cursor/mcp.json</code> with the MCP bridge.</p>

            <h3>2. <i class="uil uil-file-edit-alt"></i> VS Code + Continue.dev</h3>
            <p>Edit <code style="display:inline; margin:0;">~/.continue/config.yaml</code> (or use Continue's settings UI):</p>
            <pre><code>name: Gemini Proxy
version: 1.0.0
schema: v1
models:
  - name: Gemini
    provider: openai
    model: gpt-4
    apiBase: http://localhost{{.ServerPort}}/v1
    apiKey: x</code></pre>

            <h3>3. <i class="uil uil-atom"></i> Antigravity</h3>
            <p>Open Antigravity settings and configure:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                <li><strong>Provider:</strong> OpenAI Compatible / Custom OpenAI</li>
                <li><strong>Base URL:</strong> <code style="display:inline; margin:0;">http://localhost{{.ServerPort}}/v1</code></li>
                <li><strong>API Key:</strong> Any value (e.g., <code style="display:inline; margin:0;">x</code>) - ignored by proxy</li>
                <li><strong>Model:</strong> <code style="display:inline; margin:0;">gpt-4</code> (proxy translates to Gemini)</li>
            </ul>
            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">Note: Ensure the proxy server is running before using Antigravity.</p>

            <h3>4. <i class="uil uil-bolt"></i> Zed Editor</h3>
            <p>Edit <code style="display:inline; margin:0;">~/.config/zed/settings.json</code>:</p>
            <pre><code>{"language_models":{"openai":{"api_url":"http://localhost{{.ServerPort}}/v1","available_models":[{"name":"gpt-4","max_tokens":128000}]}}}</code></pre>

            <h3>5. <i class="uil uil-plug"></i> Claude Desktop</h3>
            <pre><code>{"mcpServers":{"gemini-brain":{"command":"go","args":["run","{{.MCPPath}}"]}}}</code></pre>

            <h3><i class="uil uil-cog"></i> Server Modes</h3>
            <pre><code>go run main.go                    # Clean mode
go run main.go -cache .           # Cache current dir
go run main.go -cache-id xxx      # Use existing cache
go run main.go -debug             # Debug logging</code></pre>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSettings()">&times;</span>
            <h2><i class="uil uil-sliders-v-alt"></i> Advanced Settings</h2>
            
            <div class="setting-group">
                <h3><i class="uil uil-shield-check"></i> Safety Settings</h3>
                <p class="setting-description">Control Google's content filtering. BLOCK_NONE allows unrestricted responses for coding/technical content.</p>
                
                <label>
                    <input type="checkbox" id="safety-harassment" checked>
                    <span>Disable Harassment Filter</span>
                </label>
                
                <label>
                    <input type="checkbox" id="safety-hate" checked>
                    <span>Disable Hate Speech Filter</span>
                </label>
                
                <label>
                    <input type="checkbox" id="safety-sexual" checked>
                    <span>Disable Sexually Explicit Filter</span>
                </label>
                
                <label>
                    <input type="checkbox" id="safety-dangerous" checked>
                    <span>Disable Dangerous Content Filter</span>
                </label>
                
                <p class="setting-description" style="margin-top: 0.75rem; color: rgba(239, 68, 68, 0.8);">
                    <i class="uil uil-exclamation-triangle"></i> <strong>Note:</strong> Model-level restrictions still apply (no illegal/harmful content).
                </p>
            </div>
            
            <div class="setting-group">
                <h3><i class="uil uil-temperature-half"></i> Temperature</h3>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="flex-shrink: 0;">Value:</span>
                    <span class="setting-value" id="temp-display">0.2</span>
                </div>
                <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.2">
                <p class="setting-description">
                    <strong>0.0:</strong> Deterministic (same input = same output)<br>
                    <strong>0.2:</strong> Focused, good for coding (current default)<br>
                    <strong>1.0:</strong> Balanced creativity<br>
                    <strong>2.0:</strong> Maximum creativity/randomness
                </p>
            </div>
            
            <button class="save-settings-btn" onclick="saveSettings()">
                <i class="uil uil-check"></i> Apply Settings
            </button>
        </div>
    </div>

    <div id="main-container">
        <div id="topbar">
            <h1><i class="uil uil-brain"></i> Antigravity Brain</h1>
            <div id="session-stats">
                <div class="stat-item">
                    <i class="uil uil-coins"></i>
                    <div>
                        <div class="stat-label">Session Cost</div>
                        <div class="stat-value" id="session-cost">$0.000</div>
                    </div>
                </div>
                <div class="stat-item">
                    <i class="uil uil-analytics"></i>
                    <div>
                        <div class="stat-label">Total Tokens</div>
                        <div class="stat-value" id="total-tokens">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chat-window">
            <div class="message bot-msg">Hello! I am your Antigravity Brain. How can I help you today?</div>
        </div>
        <div id="input-wrapper">
            <div id="attachments"></div>
            <div id="input-row">
                <input type="text" id="msg-input" placeholder="Type a message or paste an image..." autofocus>
                <button id="send-btn" onclick="sendMessage()"><i class="uil uil-message"></i> Send</button>
            </div>
        </div>
    </div>

    <script>
        // State - persist session ID across page refreshes
        let sessionID = sessionStorage.getItem('sessionID') || 'web-' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('sessionID', sessionID);
        
        let selectedFiles = new Set();
        let pastedImages = [];
        let activeCache = '{{.CacheName}}';
        const defaultModel = '{{.CacheModel}}';
        
        // Session stats - persist across refreshes
        let sessionStats = {
            totalCost: 0,
            totalTokens: 0
        };
        
        // Load stats from localStorage
        function loadSessionStats() {
            const stored = localStorage.getItem('sessionStats_' + sessionID);
            if (stored) {
                sessionStats = JSON.parse(stored);
                updateStatsDisplay();
                console.log('[Stats] Loaded from localStorage:', sessionStats);
            }
        }
        
        function saveSessionStats() {
            localStorage.setItem('sessionStats_' + sessionID, JSON.stringify(sessionStats));
        }
        
        function updateStatsDisplay() {
            document.getElementById('session-cost').textContent = '$' + sessionStats.totalCost.toFixed(6);
            document.getElementById('total-tokens').textContent = sessionStats.totalTokens.toLocaleString();
        }
        
        function addToStats(cost, tokens) {
            sessionStats.totalCost += cost;
            sessionStats.totalTokens += tokens;
            updateStatsDisplay();
            saveSessionStats();
        }

        // DOM refs
        const chatWindow = document.getElementById('chat-window');
        const fileTree = document.getElementById('file-tree');
        const msgInput = document.getElementById('msg-input');
        const modelSelect = document.getElementById('model-select');
        const attachments = document.getElementById('attachments');
        const cacheEl = document.getElementById('cache-name');
        const badgeEl = document.getElementById('badge-cache');
        const toolActivity = document.getElementById('tool-activity');
        
        // Log session info for debugging
        console.log('[Session] Using session ID:', sessionID);

        // Tool activity helper with localStorage persistence
        function loadToolActivityFromStorage() {
            try {
                const stored = localStorage.getItem('toolActivity_' + sessionID);
                if (stored) {
                    const logs = JSON.parse(stored);
                    logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'tool-log';
                        div.innerHTML = `<i class="uil uil-cog"></i><span class="tool-name">${log.name}</span><span class="tool-args">${log.args}</span>`;
                        toolActivity.appendChild(div);
                    });
                }
            } catch (e) {
                console.warn('[Tool Activity] Failed to load from storage:', e);
            }
        }

        function saveToolActivityToStorage() {
            try {
                const logs = Array.from(toolActivity.querySelectorAll('.tool-log')).map(log => ({
                    name: log.querySelector('.tool-name')?.textContent || '',
                    args: log.querySelector('.tool-args')?.textContent || ''
                }));
                localStorage.setItem('toolActivity_' + sessionID, JSON.stringify(logs));
            } catch (e) {
                console.warn('[Tool Activity] Failed to save to storage:', e);
            }
        }

        function addToolLog(toolName, args) {
            const log = document.createElement('div');
            log.className = 'tool-log';
            const argsStr = typeof args === 'object' ? JSON.stringify(args) : String(args);
            const truncated = argsStr.substring(0, 80) + (argsStr.length > 80 ? '...' : '');
            log.innerHTML = `<i class="uil uil-cog"></i><span class="tool-name">${toolName}</span><span class="tool-args">${truncated}</span>`;
            toolActivity.insertBefore(log, toolActivity.firstChild);
            
            // Keep only last 10 logs
            while (toolActivity.children.length > 10) {
                toolActivity.removeChild(toolActivity.lastChild);
            }
            
            // Persist to storage
            saveToolActivityToStorage();
            console.log('[Tool Activity] Logged:', toolName, truncated);
        }

        function clearToolActivity() {
            toolActivity.innerHTML = '';
            try {
                localStorage.removeItem('toolActivity_' + sessionID);
            } catch (e) {
                console.warn('[Tool Activity] Failed to clear storage:', e);
            }
        }

        // Init cache display and session info
        if (activeCache) {
            cacheEl.textContent = activeCache.split('/').pop();
            badgeEl.style.display = 'inline-block';
        } else {
            cacheEl.textContent = 'None';
        }
        
        // Display session ID
        const sessionIdEl = document.getElementById('session-id');
        if (sessionIdEl) {
            sessionIdEl.textContent = sessionID;
            sessionIdEl.title = 'Session ID: ' + sessionID;
        }
        
        // Load persisted tool activity
        loadToolActivityFromStorage();

        // File type icons
        const fileIcons = {
            'js': 'uil-java-script', 'ts': 'uil-java-script', 'jsx': 'uil-react', 'tsx': 'uil-react',
            'go': 'uil-brackets-curly', 'py': 'uil-brackets-curly', 'rb': 'uil-diamond',
            'html': 'uil-html5', 'css': 'uil-css3-simple', 'scss': 'uil-css3-simple',
            'json': 'uil-file-alt', 'yaml': 'uil-file-alt', 'yml': 'uil-file-alt',
            'md': 'uil-document-info', 'txt': 'uil-file-alt',
            'png': 'uil-image', 'jpg': 'uil-image', 'jpeg': 'uil-image', 'gif': 'uil-image', 'svg': 'uil-image',
            'pdf': 'uil-file-download-alt',
            'sh': 'uil-terminal', 'bash': 'uil-terminal',
            'default': 'uil-file'
        };

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return fileIcons[ext] || fileIcons['default'];
        }

        // Load file tree
        async function loadTree() {
            try {
                const res = await fetch('/files');
                const data = await res.json();
                fileTree.innerHTML = '';
                renderTreeLevel(data.files, fileTree, '');
            } catch (e) {
                fileTree.innerHTML = '<span style="color: var(--danger);">Error loading files</span>';
            }
        }

        function renderTreeLevel(items, container, basePath) {
            items.forEach(item => {
                const isDir = item.endsWith('/');
                const name = isDir ? item.slice(0, -1) : item;
                const fullPath = basePath ? basePath + '/' + name : name;

                if (isDir) {
                    const folder = document.createElement('div');
                    folder.className = 'tree-folder';
                    folder.innerHTML = `
                        <div class="tree-item">
                            <i class="uil uil-angle-right folder-icon"></i>
                            <i class="uil uil-folder"></i>
                            <span class="name">${name}</span>
                        </div>
                        <div class="tree-children"></div>
                    `;
                    const header = folder.querySelector('.tree-item');
                    const children = folder.querySelector('.tree-children');
                    let loaded = false;

                    header.onclick = async (e) => {
                        e.stopPropagation();
                        folder.classList.toggle('open');
                        children.classList.toggle('expanded');
                        if (!loaded && folder.classList.contains('open')) {
                            loaded = true;
                            try {
                                const res = await fetch('/files?path=' + encodeURIComponent(fullPath));
                                const data = await res.json();
                                renderTreeLevel(data.files || [], children, fullPath);
                            } catch (e) {
                                children.innerHTML = '<span style="color: var(--danger); padding-left: 1rem;">Error</span>';
                            }
                        }
                    };
                    container.appendChild(folder);
                } else {
                    const file = document.createElement('div');
                    file.className = 'tree-item';
                    file.innerHTML = `<i class="uil ${getFileIcon(name)}"></i><span class="name">${name}</span>`;
                    file.onclick = () => toggleFileSelection(fullPath, file);
                    container.appendChild(file);
                }
            });
        }

        function toggleFileSelection(path, element) {
            if (selectedFiles.has(path)) {
                selectedFiles.delete(path);
                element.classList.remove('selected');
            } else {
                selectedFiles.add(path);
                element.classList.add('selected');
            }
            updateAttachments();
        }

        function updateAttachments() {
            attachments.innerHTML = '';
            // File pills
            selectedFiles.forEach(file => {
                const pill = document.createElement('div');
                pill.className = 'attachment-pill';
                const name = file.split('/').pop();
                pill.innerHTML = `<i class="uil ${getFileIcon(name)}"></i><span>${name}</span><i class="uil uil-times remove"></i>`;
                pill.querySelector('.remove').onclick = () => {
                    selectedFiles.delete(file);
                    document.querySelectorAll('.tree-item').forEach(el => {
                        if (el.querySelector('.name')?.textContent === name) el.classList.remove('selected');
                    });
                    updateAttachments();
                };
                attachments.appendChild(pill);
            });
            // Image thumbnails
            pastedImages.forEach((img, idx) => {
                const thumb = document.createElement('div');
                thumb.className = 'attachment-thumb';
                thumb.innerHTML = `<img src="${img}"><div class="remove"><i class="uil uil-times"></i></div>`;
                thumb.querySelector('.remove').onclick = () => {
                    pastedImages.splice(idx, 1);
                    updateAttachments();
                };
                attachments.appendChild(thumb);
            });
        }

        // Handle paste for images
        msgInput.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = () => {
                        pastedImages.push(reader.result);
                        updateAttachments();
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        // Load models
        async function loadModels() {
            try {
                const res = await fetch('/models');
                const data = await res.json();
                modelSelect.innerHTML = '';
                if (!data.models?.length) {
                    modelSelect.innerHTML = '<option value="">No models</option>';
                    return;
                }
                // Sort models to put cache model first if it exists
                let exactMatchIndex = -1;
                data.models.forEach((model, idx) => {
                    const opt = document.createElement('option');
                    opt.value = model.id;
                    opt.textContent = model.name + ' (' + model.cost + ')';
                    // Prefer exact match
                    if (defaultModel && model.id === defaultModel) {
                        exactMatchIndex = idx;
                    }
                    modelSelect.appendChild(opt);
                });
                // Select exact match if found, otherwise first
                modelSelect.selectedIndex = exactMatchIndex >= 0 ? exactMatchIndex : 0;
            } catch (e) {
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        // Send message
        async function sendMessage() {
            const text = msgInput.value.trim();
            if (!text && pastedImages.length === 0) return;

            // Build user message display
            let userDisplay = text;
            if (selectedFiles.size > 0) {
                userDisplay = '[Files: ' + Array.from(selectedFiles).map(f => f.split('/').pop()).join(', ') + ']\n' + text;
            }
            appendMessage(userDisplay, 'user', pastedImages.length > 0 ? pastedImages[0] : null);
            msgInput.value = '';

            // Build prompt
            let fullPrompt = text;
            if (selectedFiles.size > 0) {
                fullPrompt = 'Files selected: ' + Array.from(selectedFiles).join(', ') + '\n\n' + text;
            }

            const useSearch = document.getElementById('search-toggle').checked;
            const useAgentic = document.getElementById('agentic-toggle').checked;
            const cacheMatch = text.match(/(cachedContents\/[a-z0-9]+)/i);
            const manualCache = cacheMatch ? cacheMatch[1] : '';

            // Clear attachments after sending
            const imagesToSend = [...pastedImages];
            selectedFiles.clear();
            pastedImages = [];
            updateAttachments();
            document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));

            const typing = appendMessage('Thinking...', 'bot');

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionID,
                        model: modelSelect.value,
                        message: fullPrompt,
                        cache_id: manualCache,
                        use_search: useSearch,
                        use_agentic: useAgentic,
                        images: imagesToSend,
                        // Advanced settings
                        temperature: advancedSettings.temperature,
                        safety_settings: {
                            harassment: advancedSettings.safetyHarassment ? 'BLOCK_NONE' : 'BLOCK_MEDIUM_AND_ABOVE',
                            hate: advancedSettings.safetyHate ? 'BLOCK_NONE' : 'BLOCK_MEDIUM_AND_ABOVE',
                            sexual: advancedSettings.safetySexual ? 'BLOCK_NONE' : 'BLOCK_MEDIUM_AND_ABOVE',
                            dangerous: advancedSettings.safetyDangerous ? 'BLOCK_NONE' : 'BLOCK_MEDIUM_AND_ABOVE'
                        }
                    })
                });
                typing.remove();
                if (res.ok) {
                    const data = await res.json();
                    console.log('[Response] Received:', {
                        tool_calls: data.tool_calls,
                        tokens: data.total_tokens,
                        cost: data.cost
                    });
                    
                    // Update session stats
                    if (data.cost && data.total_tokens) {
                        addToStats(data.cost, data.total_tokens);
                    }
                    
                    // Show tool calls in activity panel
                    if (data.tool_calls && data.tool_calls.length > 0) {
                        console.log('[Tool Calls] Processing', data.tool_calls.length, 'tool calls');
                        data.tool_calls.forEach(tc => {
                            // Parse "Executed: tool_name" format
                            const match = tc.match(/Executed:\s*(\w+)/i);
                            if (match) {
                                addToolLog(match[1], tc.replace(/Executed:\s*\w+\s*/i, '').trim() || '✓');
                            } else {
                                // Fallback to colon-split
                                const parts = tc.split(':');
                                addToolLog(parts[0] || tc, parts.slice(1).join(':').trim() || '✓');
                            }
                        });
                    } else {
                        console.log('[Tool Calls] None reported in response');
                    }
                    appendMessage(data.text, 'bot', null, data);
                } else {
                    appendMessage('Error: ' + await res.text(), 'bot');
                }
            } catch (e) {
                typing.remove();
                appendMessage('Network Error: Could not reach server.', 'bot');
            }
        }

        function appendMessage(text, type, image = null, meta = null) {
            const div = document.createElement('div');
            div.className = 'message ' + (type === 'user' ? 'user-msg' : 'bot-msg');

            if (type === 'bot') {
                div.innerHTML = marked.parse(text);
                // Add copy buttons to code blocks
                div.querySelectorAll('pre').forEach(pre => {
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.innerHTML = '<i class="uil uil-copy"></i> Copy';
                    btn.onclick = () => {
                        const code = pre.querySelector('code')?.textContent || pre.textContent;
                        navigator.clipboard.writeText(code);
                        btn.innerHTML = '<i class="uil uil-check"></i> Copied';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.innerHTML = '<i class="uil uil-copy"></i> Copy';
                            btn.classList.remove('copied');
                        }, 2000);
                    };
                    pre.appendChild(btn);
                });
                // Highlight code
                Prism.highlightAllUnder(div);
            } else {
                div.innerText = text;
            }

            // Add user image if present
            if (image && type === 'user') {
                const img = document.createElement('img');
                img.src = image;
                img.style.maxWidth = '200px';
                img.style.borderRadius = '8px';
                img.style.marginTop = '0.5rem';
                img.style.display = 'block';
                div.appendChild(img);
            }

            // Add generated images from API response
            if (meta && meta.images && meta.images.length > 0) {
                const imgContainer = document.createElement('div');
                imgContainer.style.marginTop = '1rem';
                meta.images.forEach(imgData => {
                    const img = document.createElement('img');
                    img.src = 'data:' + imgData.mime_type + ';base64,' + imgData.data;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.marginBottom = '0.5rem';
                    img.style.display = 'block';
                    imgContainer.appendChild(img);
                });
                div.appendChild(imgContainer);
            }

            // Token info
            if (meta && type === 'bot') {
                const info = document.createElement('div');
                info.className = 'token-info';
                const cost = (meta.request_cost_brl && typeof meta.request_cost_brl === 'number') ? meta.request_cost_brl.toFixed(6) : '0.000000';
                info.innerText = 'Tokens: ' + meta.prompt_tokens + ' in / ' + meta.response_tokens + ' out | Cost: $' + cost;
                div.appendChild(info);
            }

            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div;
        }

        function showHelp() { document.getElementById('help-modal').style.display = 'flex'; }
        function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }
        
        // Settings Modal
        let advancedSettings = {
            safetyHarassment: true,
            safetyHate: true,
            safetySexual: true,
            safetyDangerous: true,
            temperature: 0.2
        };
        
        // Load settings from localStorage
        function loadSettings() {
            const stored = localStorage.getItem('advancedSettings');
            if (stored) {
                advancedSettings = JSON.parse(stored);
                console.log('[Settings] Loaded from localStorage:', advancedSettings);
            }
        }
        
        function showSettings() {
            // Populate current values
            document.getElementById('safety-harassment').checked = advancedSettings.safetyHarassment;
            document.getElementById('safety-hate').checked = advancedSettings.safetyHate;
            document.getElementById('safety-sexual').checked = advancedSettings.safetySexual;
            document.getElementById('safety-dangerous').checked = advancedSettings.safetyDangerous;
            document.getElementById('temp-slider').value = advancedSettings.temperature;
            document.getElementById('temp-display').textContent = advancedSettings.temperature.toFixed(1);
            
            document.getElementById('settings-modal').style.display = 'flex';
        }
        
        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }
        
        function saveSettings() {
            advancedSettings = {
                safetyHarassment: document.getElementById('safety-harassment').checked,
                safetyHate: document.getElementById('safety-hate').checked,
                safetySexual: document.getElementById('safety-sexual').checked,
                safetyDangerous: document.getElementById('safety-dangerous').checked,
                temperature: parseFloat(document.getElementById('temp-slider').value)
            };
            
            // Save to localStorage
            localStorage.setItem('advancedSettings', JSON.stringify(advancedSettings));
            console.log('[Settings] Saved:', advancedSettings);
            
            closeSettings();
            
            // Show confirmation
            const chatWindow = document.getElementById('chat-window');
            const notice = document.createElement('div');
            notice.className = 'message bot-msg';
            notice.style.background = 'rgba(56, 189, 248, 0.2)';
            notice.style.borderColor = 'var(--accent-color)';
            notice.innerHTML = '<i class="uil uil-check-circle"></i> <strong>Settings applied!</strong> Temperature: ' + advancedSettings.temperature.toFixed(1) + ' | Safety filters: ' + (advancedSettings.safetyHarassment ? 'Disabled' : 'Enabled');
            chatWindow.appendChild(notice);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        // Update temperature display in real-time
        document.addEventListener('DOMContentLoaded', () => {
            const tempSlider = document.getElementById('temp-slider');
            const tempDisplay = document.getElementById('temp-display');
            
            if (tempSlider && tempDisplay) {
                tempSlider.addEventListener('input', (e) => {
                    tempDisplay.textContent = parseFloat(e.target.value).toFixed(1);
                });
            }
            
            // Load settings and stats on page load
            loadSettings();
            loadSessionStats();
        });
        
        function resetSession() {
            if (confirm('Start a new session? This will clear conversation history, reset cost/token counters, but keep tool activity logs.')) {
                // Generate new session ID
                sessionID = 'web-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionID', sessionID);
                
                // Reset session stats
                sessionStats = { totalCost: 0, totalTokens: 0 };
                saveSessionStats();
                updateStatsDisplay();
                
                // Update UI
                const sessionIdEl = document.getElementById('session-id');
                if (sessionIdEl) {
                    sessionIdEl.textContent = sessionID;
                    sessionIdEl.title = 'Session ID: ' + sessionID;
                }
                
                // Clear chat window but keep first message
                while (chatWindow.children.length > 1) {
                    chatWindow.removeChild(chatWindow.lastChild);
                }
                
                console.log('[Session] Reset to new ID:', sessionID);
                appendMessage('Session reset. Starting fresh with ID: ' + sessionID, 'bot');
            }
        }
        
        // Add visual feedback for agentic mode toggle
        document.getElementById('agentic-toggle').addEventListener('change', function(e) {
            const label = document.getElementById('agentic-label');
            if (e.target.checked) {
                label.style.background = 'rgba(56, 189, 248, 0.2)';
                label.style.borderColor = 'var(--accent-color)';
                console.log('[Agentic Mode] ENABLED - Tools available:', 'write_file, list_files, read_file');
            } else {
                label.style.background = 'var(--glass)';
                label.style.borderColor = 'transparent';
                console.log('[Agentic Mode] DISABLED - No file tools');
            }
        });
        
        // Trigger initial state
        if (document.getElementById('agentic-toggle').checked) {
            const label = document.getElementById('agentic-label');
            label.style.background = 'rgba(56, 189, 248, 0.2)';
            label.style.border = '1px solid var(--accent-color)';
        }

        // Keyboard shortcuts
        msgInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        document.onkeydown = (e) => { if (e.key === 'Escape') closeHelp(); };

        // Init
        loadTree();
        loadModels();
    </script>
</body>
</html>
